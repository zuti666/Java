# 第3次课程：

链接：https://pan.baidu.com/s/14QJPxRPni7GYBZfmoY8xxA 
提取码：7n4b

# 需求：编写MybatisUtil类

**好处**

测试数据库中的信息的时候，如果每次都要创建SqlSessionFactory对象，那么对系统的内耗就是巨大，所以设计一个工具类，使SqlSessionFactory只创建一次。

每当测试时候，直接使用工具类，就变得非常的高效。

### MyBatisUtil工具类

```java
package cn.smbms.utils;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;

public class MyBatisUtil {

    private static SqlSessionFactory sqlSessionFactory;

    //创建sqlSessionFactory，只创建一次
    static {//在静态代码下，sqlSessionFactory只创建一次
        try {
            InputStream inputStream= Resources.getResourceAsStream("mybatis-config.xml");
            sqlSessionFactory=new SqlSessionFactoryBuilder().build(inputStream);
        } catch (IOException e) {
            e.printStackTrace();
        }


    }

    //创建sqlSession的方法
    public static SqlSession createSqlSession(){
        return sqlSessionFactory.openSession(false);//true为事务的自动提交
    }


    //关闭sqlSession的方法
    public static  void closeSqlSession(SqlSession sqlSession){
        if(sqlSession!=null){
            sqlSession.close();
        }
    }


}

```

### 目录结构

![1583236399250](/框架备课.assets/1583236399250.png)

### 测试类

```java
import cn.smbms.utils.MyBatisUtil;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.apache.log4j.Logger;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;

public class UserMapperTest {

//创建日志对象
    Logger logger=Logger.getLogger(UserMapperTest.class);

    //测试方法
    @Test
    public void test1(){
        SqlSession sqlSession=null;
        try {
            //1 获得mybatis-config.xml文件的输入流
            InputStream inputStream= Resources.getResourceAsStream("mybatis-config.xml");
            //2 创建SqlSessionFactory对象，读取上述流
            SqlSessionFactory sqlSessionFactory=new SqlSessionFactoryBuilder().build(inputStream);
            //3  创建SqlSession对象（Connection）
            sqlSession=sqlSessionFactory.openSession();
            //4 通过sqlSession对象对mapper文件对应的接口进行方法的读取 全路径+方法名
            int count = sqlSession.selectOne("cn.smbms.dao.user.UserMapper.count");
            logger.debug("UserMapperTest test1 count:"+count);
        } catch (IOException e) {
            e.printStackTrace();
        }finally {
            sqlSession.close();
        }

    }

    @Test
    public void test2(){
        //通过MyBatisUtil公共类，进行测试
        SqlSession sqlSession = MyBatisUtil.createSqlSession();
        int count = sqlSession.selectOne("cn.smbms.dao.user.UserMapper.count");
        logger.debug("UserMapperTest test2 count:"+count);
        MyBatisUtil.closeSqlSession(sqlSession);
    }



}

```

# 需求：实现对用户列表的查询功能

### UserMapper接口中编写查询方法

![1583239045665](/框架备课.assets/1583239045665.png)

### UserMapper.xml文件中编写sql语句

![1583239141946](/框架备课.assets/1583239141946.png)

### 编写测试类

![1583239225789](/框架备课.assets/1583239225789.png)

```java
    @Test
    public void testGetUserList(){
        //通过MyBatisUtil公共类，进行测试
        SqlSession sqlSession=MyBatisUtil.createSqlSession();
        List<User> userList=new ArrayList<>();
        //方法一
      //  userList=sqlSession.selectList("cn.smbms.dao.user.UserMapper.getUserList");

        //方法二：
        userList=sqlSession.getMapper(UserMapper.class).getUserList();

        MyBatisUtil.closeSqlSession(sqlSession);
        //对集合进行遍历
        for(User u:userList){
            logger.debug(u.getId()+u.getAddress()+u.getBirthday());
        }

    }
```

# 需求：properties元素的配置使用

**如何不使用datebase.properties文件连接数据库**

### 在mybatis-config.xml中编写

**在xml文件中，&要改成如图，不然会报错**

![1583242421005](/框架备课.assets/1583242421005.png)

# 需求：给实体类起别名

![1583243913470](/框架备课.assets/1583243913470.png)

# 需求：根据用户名称查询用户列表(模糊查询)

### 编写查询接口

![1583245372216](/框架备课.assets/1583245372216.png)

### 编写xml中的sql语句

![1583245411418](/框架备课.assets/1583245411418.png)

```xml
    <!--根据用户名称查询用户列表(模糊查询) 五-->
    <select id="getUserListByUserName" resultType="User" parameterType="string">
        select * from smbms_user where userName like CONCAT('%',#{userName},'%')
    </select>
```

### 测试

![1583245483038](/框架备课.assets/1583245483038.png)

```java
 @Test
    public void testGetUserListByUserName(){
        SqlSession sqlSession = MyBatisUtil.createSqlSession();
        List<User> userList=new ArrayList<>();
        userList=sqlSession.getMapper(UserMapper.class).getUserListByUserName("李");
        MyBatisUtil.closeSqlSession(sqlSession);
        for(User u:userList){
            logger.debug(u.getId()+u.getAddress()+u.getUserName());
        }
    }

```

# 需求：查询用户列表（用户名和用户角色）-封装对象入参

**参数个数为2个的时候，我们就要封装对象入参**

### 编写查询（2个参数）接口

![1583247386989](/框架备课.assets/1583247386989.png)

### 编写xml文件（映射文件）中sql语句0

![1583247446370](/框架备课.assets/1583247446370.png)

```xml
    <!--查询用户列表（用户名userName和用户角色userRole)-封装对象入参-->
    <select id="getUserListByUser" resultType="User" parameterType="User">
        select  * from smbms_user where userName like CONCAT('%',#{userName},'%') and userRole=#{userRole}

    </select>
```

编写测试类

![1583247513518](/框架备课.assets/1583247513518.png)

# 作业

1、编写MyBatiseUtil工具类

2、实现对bill表中所有的记录详情的查询

3、配置properties元素（不使用datebase.properties文件）

4、给实体类起别名

5、根据产品名称（productName），查询所有订单列表信息（使用模糊查询）

6、根据产品名称（productName）和订单编号（billCode），查询所有订单列表信息（使用模糊查询和封装对象入参方式）

**参考bill表**

![1583247991741](/框架备课.assets/1583247991741.png)

